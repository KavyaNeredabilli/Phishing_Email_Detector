{% extends 'base.html' %}
{% block title %}Phishing Email Detector{% endblock %}
{% block content %}
<div class="space-y-8">
    <div class="relative overflow-hidden rounded-2xl border border-gray-100 bg-white shadow-sm p-6 sm:p-8">
        <div class="absolute inset-0 bg-gradient-to-tr from-blue-50 to-emerald-50 opacity-60 pointer-events-none"></div>
        <div class="relative">
            <h2 class="text-2xl sm:text-3xl font-semibold text-gray-900">Welcome back, {{ session.user_name or 'User' }} ðŸ‘‹</h2>
            <p class="mt-1 text-sm text-gray-600">Check your emails for phishing attempts with just one click.</p>
        </div>
    </div>

    <div class="grid gap-8">
        <div class="rounded-2xl border border-gray-100 bg-white shadow-sm p-6 sm:p-8">
            <h3 class="text-lg font-semibold text-gray-900">Analyze an Email</h3>
            <p class="mt-1 text-sm text-gray-600">Paste the email content or upload a file to detect phishing.</p>
            <form action="/predict" method="post" class="mt-6 space-y-4" enctype="multipart/form-data">
                <div>
                    <label for="subject" class="block text-sm font-medium text-gray-700">Email Subject</label>
                    <input id="subject" name="subject" type="text" class="mt-1 block w-full rounded-xl border-gray-200 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Subject (optional)">
                </div>
                <div>
                    <label for="content" class="block text-sm font-medium text-gray-700">Email Content</label>
                    <textarea id="content" name="content" rows="8" class="mt-1 block w-full rounded-xl border-gray-200 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Paste the email content here..."></textarea>
                </div>
                <div class="flex items-center justify-between gap-4 flex-wrap">
                    <label class="inline-flex items-center gap-3 cursor-pointer">
                        <input type="file" name="file" class="hidden" onchange="handleFileUpload(event)">
                        <span class="inline-flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">
                            <svg class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
                            Upload .txt
                        </span>
                    </label>
                    <div class="flex-1 text-right">
                        <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-blue-600 to-emerald-500 px-6 py-3 text-white font-semibold shadow-md hover:shadow-lg transition-all duration-200 hover:from-blue-700 hover:to-emerald-600">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 16h-1v-4H8l4-8v6h3l-4 6z"/></svg>
                            Detect Phishing
                        </button>
                    </div>
                </div>
            </form>
        </div>

        {% if prediction %}
        <div class="rounded-2xl border border-gray-100 bg-white shadow-sm p-6 sm:p-8">
            <h3 class="text-lg font-semibold text-gray-900">Result</h3>
            <div class="mt-4">
                <div class="rounded-xl p-4 sm:p-5 {{ 'bg-red-50 border border-red-200' if prediction == 'Phishing' else ('bg-yellow-50 border border-yellow-200' if prediction == 'Suspicious' else 'bg-emerald-50 border border-emerald-200') }}">
                    <div class="flex items-start gap-3">
                        <div class="mt-0.5">
                            {% if prediction == 'Phishing' %}
                            <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            {% elif prediction == 'Suspicious' %}
                            <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3m0 3h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>
                            {% else %}
                            <svg class="h-6 w-6 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 13l4 4L19 7"/></svg>
                            {% endif %}
                        </div>
                        <div>
                            <div class="text-base sm:text-lg font-semibold text-gray-900">{{ prediction }}</div>
                            {% if confidence %}
                                <div class="text-sm text-gray-600 mt-0.5">Confidence: {{ confidence }}</div>
                            {% endif %}
                            {% if subject %}
                                <div class="text-sm text-gray-600 mt-2"><span class="font-medium text-gray-700">Subject:</span> {{ subject }}</div>
                            {% endif %}
                            {% if content %}
                                <div class="mt-3 rounded-lg bg-gray-50 border border-gray-100 p-3 text-sm text-gray-700 whitespace-pre-wrap">{{ content }}</div>
                            {% endif %}
                            {% if feature_explain %}
                            <div class="mt-4">
                                <div class="text-sm font-medium text-gray-800">Top contributing features</div>
                                <ul class="mt-2 grid sm:grid-cols-2 gap-2">
                                    {% for feat, weight in feature_explain %}
                                    <li class="flex items-center justify-between rounded-md border border-gray-100 bg-white px-3 py-2 text-sm">
                                        <span class="text-gray-700">{{ feat }}</span>
                                        <span class="text-xs rounded px-2 py-0.5 bg-gray-50 text-gray-600">{{ '%.3f'|format(weight) }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            {% if url_findings and url_findings.urls %}
                            <div class="mt-4">
                                <div class="text-sm font-medium text-gray-800">URL analysis</div>
                                <ul class="mt-2 space-y-2">
                                    {% for f in url_findings.urls %}
                                    <li class="rounded-md border border-gray-100 bg-white p-3 text-sm">
                                        <div class="font-medium text-gray-900 break-all">{{ f.url }}</div>
                                        <div class="text-xs text-gray-500">Host: {{ f.host }}</div>
                                        {% if f.flags and f.flags|length > 0 %}
                                        <ul class="mt-1 flex flex-wrap gap-1">
                                            {% for fl in f.flags %}
                                            <li class="inline-block text-xs bg-yellow-50 text-yellow-700 border border-yellow-200 rounded px-2 py-0.5">{{ fl }}</li>
                                            {% endfor %}
                                        </ul>
                                        {% else %}
                                        <div class="text-xs text-emerald-700 bg-emerald-50 border border-emerald-200 inline-block rounded px-2 py-0.5 mt-1">No issues detected</div>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <a href="/" class="inline-flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Try Again</a>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="rounded-2xl border border-gray-100 bg-white shadow-sm p-6 sm:p-8">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Detection History</h3>
                    <p class="text-sm text-gray-600">Review past scans and their results</p>
                </div>
                <a href="/history" class="inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-4 py-2 text-white text-sm font-semibold shadow hover:bg-emerald-700">View Detection History</a>
            </div>
        </div>
    </div>
</div>

<script>
function handleFileUpload(e){
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function() {
        const textarea = document.getElementById('content');
        if (textarea) textarea.value = reader.result;
    };
    reader.readAsText(file);
}
</script>
{% endblock %}